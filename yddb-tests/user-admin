\i yddb-create.sql

select 'create';
with txn as (
    insert into transaction (yd_userid, yd_ipaddr, yd_useragent)
        values (0, '127.0.0.1', 'yddb-tests/user-admin')
        returning id
) insert into yd_userV (txnid, obj)
select txn.id, row('Alice')::yd_user_t
from txn;
select * from yd_userV;
select * from yd_user;

select 'update';
with txn as (
    insert into transaction (yd_userid, yd_ipaddr, yd_useragent)
        values (0, '127.0.0.1', 'yddb-tests/user-admin')
        returning id
) insert into yd_userV (txnid, id, obj)
select txn.id, u.id, row('Bob')::yd_user_t
from txn,
    (select id from yd_user where (obj).name='Alice') AS u;
select * from yd_userV;
select * from yd_user;

select 'delete';
with txn as (
    insert into transaction (yd_userid, yd_ipaddr, yd_useragent)
        values (0, '127.0.0.1', 'yddb-tests/user-admin')
        returning id
) insert into yd_userV (txnid, id, obj)
select txn.id, u.id, null
from txn,
    (select id from yd_user where (obj).name='Bob') AS u;
select * from yd_userV;
select * from yd_user;
